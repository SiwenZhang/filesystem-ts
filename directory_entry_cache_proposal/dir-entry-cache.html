<html>

<head>
<meta http-equiv="Content-Language" content="en-us">
<meta name="GENERATOR" content="Microsoft FrontPage 5.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Directory Entry Caching</title>
<style>
body
{
  font-family: arial, sans-serif;
  max-width: 6.75in;
  margin: 0px auto;
  font-size: 85%;
}
 ins  {background-color: #CCFFCC; text-decoration: none;}
 del  {background-color: #FFCACA; text-decoration: none;}
 pre  {background-color: #D7EEFF; font-size: 95%; font-family: "courier new", courier, serif;}
 code {font-size: 110%; font-family: "courier new", courier, serif;}
 table {font-size: 90%;}
</style>
</head>

<body>

<table>
<tr>
  <td align="left">Doc. no.:</td>
  <td align="left">D<span style="background-color: #FFFF00">xxxx</span>R0</td>
</tr>
<tr>
  <td align="left">Date:</td>
  <td align="left">
  <!--webbot bot="Timestamp" S-Type="EDITED" S-Format="%Y-%m-%d" startspan -->2016-02-21<!--webbot bot="Timestamp" endspan i-checksum="12138" --></td>
</tr>
<tr>
  <td align="left">Reply to:</td>
  <td align="left">Beman Dawes &lt;bdawes at acm dot org&gt;</tr>
<tr>
  <td align="left">Audience:</td>
  <td align="left">Library, Filesystem</td>
</tr>
</table>

<h1 align="center">Directory Entry Caching for Filesystem</h1>


<p align="center"><b>Fixing issue 2663 [filesys.ts] Enable efficient retrieval 
of file size from <code>directory_entry</code></b></p>


  <h2><a name="Introduction">Introduction</a></h2>

  <p>Directory iteration in real-world operating systems returns directory 
  entries containing file name plus additional information such as file status, 
  size, and last modification date. Exactly what additional information is 
  returned varies between operating systems. Accessing the additional 
  information from the directory entry is much more efficient than re-accessing 
  the file system to obtain the information.</p>

  <p dir="ltr">The initial filesystem TS proposal
  <span style="background-color: #FFFF00">(need reference)</span> and the Boost 
  Filesystem implementation limited the additional information stored in a 
  directory entry to the regular status and symlink status, since these were the 
  only additional elements present for most operating systems. The caching of 
  this additional information was described using mutable exposition-only 
  members. The LWG removed the mutable members and associated caching wording 
  because mutable members are problematic and race prone in multi-threaded 
  environments. In retrospect, the design also exposed too many implementation 
  details and was not extendible to additional information.</p>

  <p dir="ltr">This paper proposes a new approach to caching that exposes no 
  implementation details beyond the fact that some information is cached. It is 
  extendible to additional information by implementations without any need to 
  make changes to the filesystem TS (or standard library). It makes minimal 
  changes to existing interfaces and implementations.</p>

  <p dir="ltr">LWG issue 2663, <i>[filesys.ts] Enable efficient retrieval of 
  file size from </i><code><i>directory_entry</i></code>, requests that for 
  Windows, caching be extended to file size. Although this request was made 
  before the LWG removed caching, it is indicative of the desire to maximize 
  efficiency for particular operating systems.</p>

  <h2>Proposed wording</h2>

<h2>12  <a name="Class-directory_entry">Class <code>directory_entry</code></a> [class.directory_entry]</h2>

<pre para_num="1">namespace std { namespace experimental { namespace filesystem { inline namespace v1 {

  class directory_entry
  {
  public:

    // <a href="#directory_entry-constructors">constructors</a> and destructor
    directory_entry() noexcept = default;
    directory_entry(const directory_entry&amp;) = default;
    directory_entry(directory_entry&amp;&amp;) noexcept = default;
    explicit directory_entry(const path&amp; p);
    <ins>directory_entry(const path&amp; p, error_code& ec);</ins>
   ~directory_entry();

    // <a href="#directory_entry-modifiers">modifiers</a>
    directory_entry&amp; operator=(const directory_entry&amp;) = default;
    directory_entry&amp; operator=(directory_entry&amp;&amp;) noexcept = default;
    void assign(const path&amp; p);
    <ins>void assign(const path&amp; p, error_code&amp; ec);</ins>
    <ins>void refresh();</ins>
    <ins>void refresh(error_code&amp; ec) noexcept;</ins>
    void replace_filename(const path&amp; p);

    // <a href="#directory_entry-observers">observers</a>
    const path&amp;  path() const noexcept;
    operator const path&amp;() const noexcept;
    <del>file_status  status() const;</del>
    <del>file_status  status(error_code&amp; ec) const noexcept;</del>
    <del>file_status  symlink_status() const;</del>
    <del>file_status  symlink_status(error_code&amp; ec) const noexcept;</del>

    bool operator&lt; (const directory_entry&amp; rhs) const noexcept;
    bool operator==(const directory_entry&amp; rhs) const noexcept;
    bool operator!=(const directory_entry&amp; rhs) const noexcept;
    bool operator&lt;=(const directory_entry&amp; rhs) const noexcept;
    bool operator&gt; (const directory_entry&amp; rhs) const noexcept;
    bool operator&gt;=(const directory_entry&amp; rhs) const noexcept;
  private:
    path   m_path; // for exposition only
  };

} } } }  // namespaces std::experimental::filesystem::v1  </pre>
<p para_num="2">A <code>directory_entry</code> object stores a <code>path</code> object.</p>
<p><ins>Implementations are permitted and encouraged to cache additional information in <code>directory_entry</code> 
objects if such information is available during directory iteration and doing so would improve efficiency of status and other operational query functions. 
Implementations are permitted and encouraged to overload status and other 
operational query functions that take <code>const path&amp;</code> arguments with 
additional signatures taking <code>const directory_entry&amp;</code> arguments and 
satisfy the status or other operational query from the <code>directory_entry</code> 
argument&#39;s 
cache.</ins></p>
<p><ins>[<i>Note: </i>Users wishing to make use of cached <code>directory_entry</code> 
additional information should call status and other operational query functions 
using the <code>directory_entry</code> object as an argument. Users wishing to 
ensure that an operational function returns the most recent available 
information should call the function with a <code>path</code> object or an 
object that is convertible to <code>path</code>. —<i>end note</i>]</ins></p>
<p><ins>[<i>Note: </i>Operational query functions that may benefit from caching 
include <code>status</code>, <code>symlink_status</code>, <code>exists</code>,
<code>is_block_file</code>, <code>is_character_file</code>, i<code>s_directory</code>,
<code>is_fifo</code>, <code>is_other</code>, <code>is_regular_file</code>, <code>
is_socket</code>, <code>is_symlink</code>, <code>status_known</code>, <code>
last_write_time</code>, and <code>file_size</code>.&nbsp; —<i>end note</i>]</ins></p>
<p><ins>[<i>Example: <span style="background-color: #FFFF00">TBS</span> </i>—<i>end 
example</i>]</ins></p>
<h3>12.1 <a name="directory_entry-constructors"><code>directory_entry</code> 
constructors </a>[directory_entry.cons] </h3>
<pre para_num="1">explicit directory_entry(const path&amp; p);
<ins>directory_entry(const path&amp; p, error_code& ec);</ins></pre>
<blockquote>
  <p para_num="2"><i>Effects: </i>Constructs an object of type <code>directory_entry</code><ins>, 
  then <code>refresh(<i>[ec]</i>)</code></ins>.
  </p>
  <p para_num="3" dir="ltr"><i>Postcondition:</i> <code>path() == p</code>.</p>
  <p para_num="3" dir="ltr"><ins><i>Throws:</i> As specified in <a href="#Error-reporting">Error 
  reporting (7)</a>.</ins> </p>
</blockquote>
<h3>12.2 <a name="directory_entry-modifiers"><code>directory_entry</code> 
modifiers </a>[directory_entry.mods] </h3>
<pre para_num="1">void assign(const path&amp; p);
<ins>void assign(const path&amp; p, error_code&amp; ec);</ins></pre>
<blockquote>
  <p para_num="2"><ins><i>Effects:</i> <code>refresh(<i>[ec]</i>)</code>.</ins></p>
  <p para_num="2"><i>Postcondition:</i> <code>path() == p</code>.</p>
  <p para_num="2"><ins><i>Throws:</i> As specified in <a href="#Error-reporting">Error 
  reporting (7)</a>.</ins> </p>
</blockquote>
<pre><ins>void refresh();</ins>
<ins>void refresh(error_code&amp; ec) noexcept;</ins></pre>
<blockquote>
<p para_num="4" dir="ltr"><ins><i>Effects:</i> Stores current values for the 
attributes of
the file <code>p</code> resolves to in the additional information cache, if 
any.</ins></p>
<p para_num="4"><ins><i>Throws:</i> As specified in <a href="#Error-reporting">Error 
  reporting (7)</a>.</ins> </p>
</blockquote>
<pre para_num="3">void replace_filename(const path&amp; p);</pre>
<blockquote>
  <p para_num="4"><i>Postcondition:</i> <code>path() == x.parent_path() / p</code> where <code>x</code> is the value of <code>path()</code> before the function is 
  called. </p>
</blockquote>
</blockquote>
<h3>12.3 <a name="directory_entry-observers"><code>directory_entry</code> observers </a>[directory_entry.obs] </h3>
<pre para_num="1">const path&amp; path() const noexcept;
operator const path&amp;() const noexcept;</pre>
<blockquote>
  <p para_num="2"><i>Returns:</i> <code>m_path</code> </p>
</blockquote>
<pre para_num="3"><del>file_status status() const;</del>
<del>file_status status(error_code&amp; ec) const noexcept;</del></pre>
<blockquote>
  <p para_num="4"><del><i>Returns:</i> <code>status(path()<i>[, ec]</i>)</code></del>. </p>
  <p para_num="5"><del><i>Throws:</i> As specified in <a href="#Error-reporting">Error 
  reporting (7)</a>.</del></p>
</blockquote>
<pre para_num="6"><del>file_status  symlink_status() const;</del>
<del>file_status  symlink_status(error_code&amp; ec) const noexcept;</del></pre>
<blockquote>
   <p para_num="7"><del><i>Returns:</i> <code>symlink_status(path()<i>[, ec]</i>)</code>.</del></p>
  <p para_num="8"><del><i>Throws:</i> As specified in <a href="#Error-reporting">Error 
  reporting (7)</a>.</del></p>
</blockquote>
<pre para_num="9">bool operator==(const directory_entry&amp; rhs) const noexcept;</pre>
<blockquote>
  <p para_num="10"><i>Returns:</i> <code>m_path == rhs.m_path</code>. </p>
</blockquote>
<pre para_num="11">bool operator!=(const directory_entry&amp; rhs) const noexcept;</pre>
<blockquote>
  <p para_num="12"><i>Returns:</i> <code>m_path != rhs.m_path</code>. </p>
</blockquote>
<pre para_num="13">bool operator&lt; (const directory_entry&amp; rhs) const noexcept;</pre>
<blockquote>
  <p para_num="14"><i>Returns:</i> <code>m_path &lt; rhs.m_path</code>. </p>
</blockquote>
<pre para_num="15">bool operator&lt;=(const directory_entry&amp; rhs) const noexcept;</pre>
<blockquote>
  <p para_num="16"><i>Returns:</i> <code>m_path &lt;= rhs.m_path</code>. </p>
</blockquote>
<pre para_num="17">bool operator&gt; (const directory_entry&amp; rhs) const noexcept;</pre>
<blockquote>
  <p para_num="18"><i>Returns:</i> <code>m_path &gt; rhs.m_path</code>. </p>
</blockquote>
<pre para_num="19">bool operator&gt;=(const directory_entry&amp; rhs) const noexcept;</pre>
<blockquote>
  <p para_num="20"><i>Returns:</i> <code>m_path &gt;= rhs.m_path</code>. </p>
</blockquote>


  <h2><a name="References">References</a></h2>

<p>[<a name="1">1</a>] Beman Dawes, <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2014/n4100.pdf">N4100, Programming Languages — C++ — File System Technical Specification</a>, 
2014.<br>
<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2014/n4100.pdf" class="uri">
http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2014/n4100.pdf</a></p>
<p>[<a name="2">2</a>] Beman Dawes, others, <a href="http://www.boost.org/doc/libs/1_60_0/libs/filesystem/doc/index.htm">Boost Filesystem Library, V3</a>, 2015.<br>
<a href="https://www.boost.org/doc/libs/1_60_0/libs/filesystem/doc/index.htm" class="uri">
https://www.boost.org/doc/libs/1_60_0/libs/filesystem/doc/index.htm</a></p>

<hr>

</pre></body>

</html>